<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Futebol M√°ximo ‚Äî Saved Channels</title>
  <style>
    :root{
      --bg:#0c0c0f;
      --panel:#141418;
      --panel-2:#1b1b21;
      --text:#eaeaf0;
      --muted:#a2a2ad;
      --brand:#1ed760;
      --brand-2:#18b34f;
      --danger:#ff4d4f;
      --radius:16px;
      --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
      background:var(--bg);
      color:var(--text);
      display:flex;
    }
    /* Sidebar */
    .sidebar{
      width:280px;
      min-height:100vh;
      background:linear-gradient(180deg,#0e1012 0%, #0a0b0d 100%);
      border-right:1px solid #1f1f27;
      padding:24px 18px;
      position:sticky;
      top:0;
    }
    .logo{
      display:flex; align-items:center; gap:12px;
      font-weight:800; font-size:18px; letter-spacing:.3px;
      margin-bottom:28px;
    }
    .logo-badge{
      width:34px; height:34px; display:grid; place-items:center;
      background:var(--panel); border-radius:9px; box-shadow:var(--shadow);
    }
    .logo-badge span{font-size:18px}
    .nav{
      display:flex; flex-direction:column; gap:6px;
    }
    .nav button{
      width:100%; text-align:left; padding:12px 14px; border-radius:12px;
      border:1px solid #23232b; background:var(--panel); color:var(--text);
      cursor:pointer; font-size:14px; transition:.2s;
    }
    .nav button:hover{transform:translateY(-1px); background:var(--panel-2)}
    .nav button.active{outline:2px solid #2a2a33}

    /* Main */
    .main{
      flex:1; min-width:0; padding:28px;
      display:flex; flex-direction:column; gap:18px;
    }
    .page-header{
      display:flex; justify-content:space-between; align-items:center; gap:12px;
    }
    .h1{font-size:24px; font-weight:800; letter-spacing:.2px}
    .btn{
      appearance:none; border:none; cursor:pointer;
      padding:10px 16px; border-radius:999px; font-weight:700;
      background:var(--brand); color:#0b0f0d; transition:.15s;
      box-shadow:0 8px 24px rgba(30,215,96,.25);
    }
    .btn:hover{background:var(--brand-2); transform:translateY(-1px)}
    .btn.secondary{background:transparent; color:var(--text); border:1px solid #2a2a33; box-shadow:none}
    .btn.danger{background:var(--danger); color:white; box-shadow:0 8px 24px rgba(255,77,79,.25)}

    /* Cards grid */
    .grid{display:grid; gap:14px; grid-template-columns:repeat(auto-fill, minmax(260px,1fr));}
    .card{
      background:var(--panel); border:1px solid #23232b; border-radius:var(--radius);
      padding:16px; display:flex; flex-direction:column; gap:10px; cursor:pointer;
      transition:.15s;
    }
    .card:hover{transform:translateY(-2px); background:var(--panel-2)}
    .card-title{font-weight:800}
    .muted{color:var(--muted); font-size:13px}

    /* Toolbar inside lists */
    .toolbar{display:flex; align-items:center; gap:8px; flex-wrap:wrap}

    /* Channel chips */
    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip{
      background:#101014; border:1px solid #262632; color:#c9c9d4; font-size:12px;
      padding:6px 10px; border-radius:12px;
    }

    /* Modals */
    .modal{
      position:fixed; inset:0; display:none; place-items:center;
      background:rgba(0,0,0,.55); padding:18px; z-index:10000;
    }
    .modal.show{display:grid}
    .dialog{
      width:100%; max-width:520px; background:#1a1a1f; border:1px solid #2b2b35;
      border-radius:18px; box-shadow:var(--shadow); padding:22px; display:flex; flex-direction:column; gap:14px; position:relative;
    }
    .dialog h3{margin:0; font-size:22px}
    .field{display:flex; flex-direction:column; gap:6px}
    .input{width:100%; border-radius:12px; padding:14px 16px; border:1px solid #2b2b35; background:#0f0f14; color:var(--text); outline:none; font-size:15px;}
    .row{display:flex; gap:8px; align-items:center; justify-content:flex-end}
    .close-x{position:absolute; right:16px; top:12px; cursor:pointer; opacity:.8}

    /* Empty state */
    .empty{
      border:1px dashed #2a2a33; border-radius:16px; padding:26px; text-align:center; color:#a7a7b5;
    }

    /* Videos grid */
    .video-card{
      background:#111216; border:1px solid #262632; border-radius:14px; overflow:hidden;
    }
    .thumb{
      position:relative; aspect-ratio:16/9; background:#0b0c10;
    }
    .thumb img{width:100%; height:100%; object-fit:cover; display:block;}
    .duration{
      position:absolute; right:8px; bottom:8px; font-size:12px;
      background:rgba(0,0,0,.8); padding:2px 6px; border-radius:6px; color:#fff;
    }
    .vtitle{padding:10px 12px; font-size:14px; line-height:1.35}
    .hidden{display:none !important;}
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo">
      <div class="logo-badge"><span>‚öΩ</span></div>
      <div>Futebol M√°ximo</div>
    </div>
    <div class="nav">
      <button id="nav-saved" class="active">üì∫ Saved Channels</button>
    </div>
  </aside>

  <!-- Main Area -->
  <main class="main">
    <div class="page-header">
      <div class="h1" id="pageTitle">Saved Channels</div>
      <div id="headerActions">
        <button class="btn" id="btnCreateList">+ Criar Lista</button>
      </div>
    </div>

    <!-- Saved Lists Page -->
    <section id="pageSaved" class="page">
      <div id="listsGrid" class="grid"></div>
      <div id="emptyLists" class="empty" style="display:none">
        Nenhuma lista criada ainda. Clique em <b>+ Criar Lista</b> para come√ßar.
      </div>
    </section>

    <!-- List Detail Page -->
    <section id="pageList" class="page hidden">
      <div class="toolbar" style="margin-bottom:10px">
        <button class="btn secondary" id="btnBack">‚Üê Voltar</button>
        <span class="muted" id="listInfo"></span>
        <div style="flex:1"></div>
        <button class="btn" id="btnAddChannel">+ Adicionar Canal</button>
      </div>

      <div class="chips" id="channelsChips"></div>

      <h3 style="margin:12px 0 6px 0">V√≠deos</h3>
      <div id="videosGrid" class="grid"></div>
      <div id="emptyVideos" class="empty">
        Ap√≥s adicionar um canal, os v√≠deos aparecer√£o aqui.
      </div>
    </section>
  </main>

  <!-- Modal: Create List -->
  <div class="modal" id="modalList" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="createListTitle">
      <div class="close-x" data-close="modalList" aria-label="Fechar">‚úï</div>
      <h3 id="createListTitle">Create List</h3>
      <div class="field">
        <label for="listName" class="muted">Name</label>
        <input id="listName" class="input" placeholder="Ex.: Canais de Futebol Europeu">
      </div>
      <div class="row">
        <button class="btn secondary" data-close="modalList">Cancelar</button>
        <button class="btn" id="confirmCreateList">Save</button>
      </div>
    </div>
  </div>

  <!-- Modal: Add Channel -->
  <div class="modal" id="modalChannel">
    <div class="dialog">
      <div class="close-x" data-close="modalChannel" aria-label="Fechar">‚úï</div>
      <h3>Adicionar canal √† lista</h3>
      <div class="field">
        <label for="channelUrl" class="muted">URL do canal do YouTube</label>
        <input id="channelUrl" class="input" placeholder="https://www.youtube.com/@nomedocanal">
      </div>
      <div class="row">
        <button class="btn secondary" data-close="modalChannel">Cancelar</button>
        <button class="btn" id="confirmAddChannel">Trackear Canal</button>
      </div>
      <div class="muted" style="font-size:12px">Ser√£o exibidos os v√≠deos mais recentes (thumb, t√≠tulo, dura√ß√£o).</div>
    </div>
  </div>

  <script>
    // ==== CONFIG: YouTube API Key (fornecida pelo usu√°rio) ====
    const YT_API_KEY = "AIzaSyD2737mJtrmC5efJz4gntSAxochOoq8LpE";

    // ------ Estado / Persist√™ncia ------
    const STORAGE_KEY = 'fm_lists_v2';
    function loadState(){
      try {
        // tentar carregar v2, sen√£o v1 (migra√ß√£o simples)
        const v2 = localStorage.getItem(STORAGE_KEY);
        if (v2) return JSON.parse(v2);
        const v1 = localStorage.getItem('fm_lists');
        if (v1) {
          const migrated = JSON.parse(v1);
          localStorage.setItem(STORAGE_KEY, JSON.stringify(migrated));
          return migrated;
        }
        return {lists:[]};
      } catch { return {lists:[]} }
    }
    function saveState(state){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
    let state = loadState();
    // Seed inicial se n√£o houver nada
    if (!state.lists || state.lists.length === 0) {
      state = {lists:[{id: uid(), name: "Futebol Internacional", createdAt: Date.now(), channels: []}]};
      saveState(state);
    }
    let currentListId = null;

    // ------ Util ------
    const qs = (s, el=document)=>el.querySelector(s);
    const qsa = (s, el=document)=>[...el.querySelectorAll(s)];
    function uid(){ return Math.random().toString(36).slice(2,10); }
    function showPage(id){
      qsa('.page').forEach(p=>p.classList.add('hidden'));
      qs('#'+id).classList.remove('hidden');
      if(id==='pageSaved'){
        qs('#pageTitle').textContent='Saved Channels';
      } else if(id==='pageList'){
        const list = state.lists.find(l=>l.id===currentListId);
        qs('#pageTitle').textContent = list ? list.name : 'Lista';
      }
    }
    function openModal(id){
      const m = qs('#'+id);
      m.classList.add('show');
      m.setAttribute('aria-hidden','false');
      const input = m.querySelector('input');
      if(input) setTimeout(()=>input.focus(),50);
    }
    function closeModal(id){
      const m = qs('#'+id);
      m.classList.remove('show');
      m.setAttribute('aria-hidden','true');
    }

    // Fechar modal clicando no fundo ou com ESC
    qsa('.modal').forEach(m=>{
      m.addEventListener('click', (e)=>{ if(e.target===m){ closeModal(m.id); } });
    });
    document.addEventListener('keydown', (e)=>{
      if(e.key==='Escape') qsa('.modal.show').forEach(m=>closeModal(m.id));
    });
    const rebindModalCloses = ()=> qsa('[data-close]').forEach(btn=>{
      btn.onclick = ()=> closeModal(btn.getAttribute('data-close'));
    });
    rebindModalCloses();

    // ------ Listas UI ------
    function renderLists(){
      const grid = qs('#listsGrid');
      grid.innerHTML = '';
      if(state.lists.length===0){
        qs('#emptyLists').style.display='block';
        return;
      }
      qs('#emptyLists').style.display='none';
      state.lists.forEach(list=>{
        const el=document.createElement('div');
        el.className='card';
        el.innerHTML = `
          <div class="card-title">${list.name}</div>
          <div class="muted">${list.channels.length} canal(is)</div>
        `;
        el.addEventListener('click', ()=>openList(list.id));
        grid.appendChild(el);
      });
    }

    function createList(name){
      const id = uid();
      state.lists.push({id, name, createdAt:Date.now(), channels:[]});
      saveState(state);
      renderLists();
      return id;
    }

    function openList(id){
      currentListId = id;
      const list = state.lists.find(l=>l.id===id);
      if(!list) return;
      showPage('pageList');
      renderListDetail();
    }

    function renderListDetail(){
      const list = state.lists.find(l=>l.id===currentListId);
      if(!list) return;
      qs('#pageTitle').textContent=list.name;
      qs('#listInfo').textContent = `Criada em ${new Date(list.createdAt).toLocaleDateString()} ‚Ä¢ ${list.channels.length} canal(is)`;
      const chips = qs('#channelsChips');
      chips.innerHTML='';
      list.channels.forEach(ch=>{
        const c=document.createElement('span');
        c.className='chip';
        c.textContent = ch.handle || ch.url;
        chips.appendChild(c);
      });
      qs('#videosGrid').innerHTML = '';
      qs('#emptyVideos').style.display = 'block';
      // Se houver canais nessa lista, carregar v√≠deos do 1¬∫ canal (comportamento simples)
      if (list.channels.length > 0) {
        fetchAndRenderVideos(list.channels[0].url);
      }
    }

    function addChannelToCurrentList(url, handle, channelId){
      const list = state.lists.find(l=>l.id===currentListId);
      if(!list) return;
      const exists = list.channels.some(c=>c.url===url || c.channelId===channelId);
      if(!exists){
        list.channels.push({id:uid(), url, handle, channelId, addedAt:Date.now()});
        saveState(state);
      }
      renderListDetail();
    }

    // ------ Eventos ------
    qs('#nav-saved').addEventListener('click', ()=>{ currentListId=null; showPage('pageSaved'); renderLists(); });
    qs('#btnCreateList').addEventListener('click', ()=>openModal('modalList'));
    qs('#confirmCreateList').addEventListener('click', ()=>{
      const name = qs('#listName').value.trim();
      if(!name){ qs('#listName').focus(); return; }
      const id = createList(name);
      qs('#listName').value='';
      closeModal('modalList');
      openList(id);
    });
    qs('#btnBack').addEventListener('click', ()=>{ currentListId=null; showPage('pageSaved'); renderLists(); });
    qs('#btnAddChannel').addEventListener('click', ()=>openModal('modalChannel'));
    qs('#confirmAddChannel').addEventListener('click', async ()=>{
      const url = qs('#channelUrl').value.trim();
      if(!url){ qs('#channelUrl').focus(); return; }
      closeModal('modalChannel');
      const handleMatch = url.match(/@([a-zA-Z0-9._-]+)/);
      const handle = handleMatch ? '@'+handleMatch[1] : null;
      // Resolve e salva
      const channelId = await resolveChannelId(url);
      if(!channelId){ alert('N√£o foi poss√≠vel resolver o canal. Verifique a URL.'); return; }
      addChannelToCurrentList(url, handle, channelId);
      await fetchAndRenderVideos(url);
      qs('#channelUrl').value='';
    });

    // ------ YouTube Helpers ------
    async function fetchAndRenderVideos(channelUrl){
      toggleVideosLoading(true);
      try{
        const channelId = await resolveChannelId(channelUrl);
        if(!channelId){ alert('N√£o foi poss√≠vel resolver o canal. Verifique a URL.'); toggleVideosLoading(false); return; }

        // 1) Buscar √∫ltimos v√≠deos (ids)
        const searchRes = await fetch(`https://www.googleapis.com/youtube/v3/search?key=${YT_API_KEY}&channelId=${channelId}&part=snippet,id&order=date&maxResults=24&type=video`);
        const searchData = await searchRes.json();
        const ids = (searchData.items||[]).map(it=>it.id && it.id.videoId).filter(Boolean);
        if(ids.length===0){ renderVideos([]); toggleVideosLoading(false); return; }

        // 2) Trazer detalhes para dura√ß√£o
        const detailsRes = await fetch(`https://www.googleapis.com/youtube/v3/videos?key=${YT_API_KEY}&id=${ids.join(',')}&part=contentDetails,snippet`);
        const detailsData = await detailsRes.json();
        const videos = (detailsData.items||[]).map(v=>({
          id: v.id,
          title: v.snippet.title,
          thumb: (v.snippet.thumbnails && (v.snippet.thumbnails.high || v.snippet.thumbnails.medium || v.snippet.thumbnails.default)).url,
          duration: formatISODuration(v.contentDetails.duration)
        }));
        renderVideos(videos);
      } catch(e){
        console.error(e);
        alert('Erro ao carregar v√≠deos.');
      } finally {
        toggleVideosLoading(false);
      }
    }

    async function resolveChannelId(url){
      // Cache local simples por URL
      const cacheKey = 'fm_channel_cache_v1';
      const cache = JSON.parse(localStorage.getItem(cacheKey) || '{}');
      if (cache[url]) return cache[url];

      let channelId = null;
      try {
        // /channel/UCxxxx
        const channelMatch = url.match(/\/channel\/([a-zA-Z0-9_-]+)/);
        if (channelMatch) channelId = channelMatch[1];

        // /user/username
        if (!channelId) {
          const userMatch = url.match(/\/user\/([^/?#]+)/);
          if (userMatch) {
            const username = userMatch[1];
            const resp = await fetch(`https://www.googleapis.com/youtube/v3/channels?part=id&forUsername=${encodeURIComponent(username)}&key=${YT_API_KEY}`);
            const data = await resp.json();
            if (data.items && data.items.length) channelId = data.items[0].id;
          }
        }

        // @handle (novo) via forHandle
        if (!channelId) {
          const handleMatch = url.match(/@([A-Za-z0-9._-]+)/);
          if (handleMatch) {
            const handle = handleMatch[1];
            // Primeiro tenta via forHandle (mais preciso)
            let resp = await fetch(`https://www.googleapis.com/youtube/v3/channels?part=id&forHandle=${encodeURIComponent(handle)}&key=${YT_API_KEY}`);
            let data = await resp.json();
            if (data.items && data.items.length) {
              channelId = data.items[0].id;
            } else {
              // Fallback via search (caso forHandle n√£o esteja dispon√≠vel na sua quota/conta)
              resp = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=channel&q=${encodeURIComponent('@'+handle)}&maxResults=1&key=${YT_API_KEY}`);
              data = await resp.json();
              if (data.items && data.items.length) channelId = data.items[0].id.channelId;
            }
          }
        }

        // fallback: tentar extrair ID UC... no texto
        if (!channelId) {
          const uc = url.match(/(UC[0-9A-Za-z_-]{22})/);
          if (uc) channelId = uc[1];
        }
      } catch (e) {
        console.error('resolveChannelId error', e);
      }

      if (channelId) {
        cache[url] = channelId;
        localStorage.setItem(cacheKey, JSON.stringify(cache));
      }
      return channelId;
    }

    function renderVideos(videos){
      const grid = qs('#videosGrid');
      grid.innerHTML='';
      if(!videos || videos.length===0){
        qs('#emptyVideos').style.display='block';
        return;
      }
      qs('#emptyVideos').style.display='none';
      videos.forEach(v=>{
        const card = document.createElement('div');
        card.className = 'video-card';
        card.innerHTML = `
          <div class="thumb">
            <img src="${v.thumb}" loading="lazy" alt="thumb">
            <div class="duration">${v.duration}</div>
          </div>
          <div class="vtitle">${v.title}</div>
        `;
        grid.appendChild(card);
      });
    }

    function toggleVideosLoading(loading){
      const grid = qs('#videosGrid');
      if(loading){
        grid.innerHTML = '<div class="muted">Carregando v√≠deos‚Ä¶</div>';
        qs('#emptyVideos').style.display='none';
      }
    }

    function formatISODuration(iso){
      // ISO 8601 -> "H:MM:SS" or "MM:SS"
      const m = iso && iso.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
      if(!m) return '0:00';
      const h = parseInt(m[1]||0,10);
      const min = parseInt(m[2]||0,10);
      const s = parseInt(m[3]||0,10);
      const mm = String(min).padStart(2,'0');
      const ss = String(s).padStart(2,'0');
      return h ? `${h}:${mm}:${ss}` : `${min}:${ss.padStart(2,'0')}`;
    }

    // ------ Inicializa√ß√£o ------
    function boot(){
      renderLists();
      const firstListId = state.lists[0]?.id;
      if(firstListId){ openList(firstListId); }
    }

    // Bind bot√µes topo
    qs('#btnCreateList').addEventListener('click', ()=>openModal('modalList'));
    rebindModalCloses();

    // Inicia
    boot();
  </script>
</body>
</html>
